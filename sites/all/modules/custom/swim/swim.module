<?php
/**
 * @todo Create SWIM text format at install.
 */



/**
 * Implements hook_help().
 */
function swim_help($path, $arg) {
  switch ($path) {
    case 'admin/help#swim':
      return '<p>' . t('Helpy help help, <a href="@jquery">jQuery</a>.', 
          array(
            '@jquery' => 'http://jquery.com',
          )) . '</p>';
  }
}

/**
 * Implementation of hook_perm().
 */
function swim_permission() {
  return array(
    'preview content' => array(
      'title' => t('Preview content'),
      'description' => t('See what content will look like on a device.')
    ),
  );
}

/**
 * Implements hook_menu().
 */
function swim_menu() {
  $items = array();
  $items['swim-mt-preview'] = array(
    'page callback' => 'swim_mt_preview',
    'access callback' => 'user_access',
    'access arguments' => array('preview content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

function swim_form_alter(&$form, &$form_state, $form_id) {
  // @todo Instead of checking form_is, check for a field
  //having the SWIM format? Cache the results of the check 
  //so don't run check again on this page call.
  //Not sure if this is the right approach.
  if ( stristr($form_id, 'node_form') !== FALSE ) {
    //Check perm.
    if ( !user_access('preview content') ) {
      return;
    }
    if (module_invoke('ajax_markup', 'on')) {
      drupal_add_library('system', 'ui.dialog');
      //Load JS for doing previews. Load it early, to set stuff up afore
      //CK does its thing.
      drupal_add_js(
          drupal_get_path('module', 'swim') .'/js/swim.js',
          array(
            'group' => JS_DEFAULT,
            'weight' => -20,
          )
      );
      drupal_add_css(drupal_get_path('module', 'swim') . '/css/swim.css' );
      //Load JS to hide things.
      //Load late, so the link to hide has been built.
      drupal_add_js(
          drupal_get_path('module', 'swim') .'/js/swim_hide_things.js',
        array(
          'group' => JS_THEME,
          'weight' => 20,
        )
      );
      //Send some settings to JS.
      global $base_url;
      $body_format_name = $form['body'][LANGUAGE_NONE][0]['#format'];
      $settings = array(
        'base_url' => $base_url,
        'format_name' => $body_format_name,
      );
      drupal_add_js(
          array('swim' => $settings),
          'setting'
      );
    }
  }
}

/**
 * Return a page with the right media queries and such, and a place to 
 * put markup.
 * @return array Output - renderable array.
 */
function swim_mt_preview() {
  //Check perm.
  if ( !user_access('preview content') ) {
    return MENU_ACCESS_DENIED;
  }
  //Grab the front page, and send it to the client.
  $front_url = variable_get('site_frontpage', 'node');
  $front_url = trim($front_url, '/');
  $front = explode('/', $front_url);
  $front_nid = $front[1];
  $node = node_load($front_nid);
  $renderable = node_view($node, 'full');
  return $renderable;
}


// function swim_filter_info_alter(&$info) {
//   $info['filter_markdown']['process callback'] = 'swim_preprocess_markdown';
//   $r=5;
// }
//
//function swim_preprocess_markdown($text, $filter, $format) {
//  //Replace with regex.
//  $text = str_ireplace('<br/>', "", $text);
//  $text = str_ireplace('<br />', "", $text);
//  $text = str_ireplace('<br>', "", $text);
//  $text = str_ireplace('{aside}', '<aside>', $text);
//  $text = str_ireplace('{/aside}', '</aside>', $text);
//  return _filter_markdown($text, $format);
//}

/**
* Implements hook_filter_info().
*/
function swim_filter_info() {
  $filters['filter_swim'] = array(
    'title' => t('SWIM'),
    'description' => t('Show What I Mean'),
//    'prepare callback' => '_dgd7_tip_prepare',
    'process callback' => 'swim_process_filter',
//    'tips callback' => 'swim_tips',
  );
  return $filters;
}

require_once drupal_get_path('module', 'swim') .'/libs/markdown_extra/Markdown.php';
require_once drupal_get_path('module', 'swim') .'/libs/markdown_extra/MarkdownExtra.php';
//use \Michelf\Markdown;

# Install PSR-0-compatible class autoloader
//spl_autoload_register(function($class){
//	require preg_replace('{\\\\|_(?!.*\\\\)}', DIRECTORY_SEPARATOR, ltrim($class, '\\')).'.php';
//});

//function swim_process($text, $filter, $format) {
function swim_process_filter($text, $filter, $format = 'SWIM', $langcode = 'und') {
//  return $text;
  $text = str_ireplace('<br/>', "", $text);
  $text = str_ireplace('<br />', "", $text);
  $text = str_ireplace('<br>', "", $text);
  $text = str_ireplace('{aside}', '<aside class="swim" markdown="1">', $text);
  $text = str_ireplace('{/aside}', '</aside>', $text);

  $html = \Michelf\MarkdownExtra::defaultTransform($text);  
  
  return $html;
  
}

function swim_tips($filter, $format, $long = FALSE) {
  return t('Failure is not an option. It comes standard.');
}


function swim_block_view_alter(&$data, $block) {
  if ( $block->delta == 'markdown_help' ) {
    $data['title'] = 'Editing tips';
    $data['content'] = 
'<p>' . t('
Blank lines separate paragraphs. Press Enter twice to make one.
') . '</p>
<p><code>' . t('# Header 1<br>
## Header 2<br>
### Header 3<br>
#### Header 4<br>
##### Header 5
') . '</code></p>
<p>' . t('Link:') . '<br><small><code>' . t('[CyberCourse](http://cybercour.se)') . '</small></code></p>
<p>' . t('Inline markup like ') . '<code>_' . t('italics') . '_</code>,
 and <code>**' . t('bold') . '**</code>.</p>
<p><code> > ' . t('This is a quote.') . '</code></p>
<p><code>* ' . t('Bulleted lists.') . '<br>
        * ' . t('Put blank lines') . '<br>
        * ' . t('around them.') . '
</code></p>
<p><code>1. ' . t('A numbered list') . '<br>
1. ' . t('Is like this.') . '<br>
1. ' . t('Another one.') . '
</code></p>
<p>' . t('Use the preview button to see how your content will look on '
. 'different devices.') . '
</p>
<p>' . t('See the <a href="http://cybercour.se">CyberCourse wiki</a> for more.') . '
</p>';
  } // End if
}