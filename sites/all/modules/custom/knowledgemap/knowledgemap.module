<?php
define( 'RELATION_NAME_ITEM_TO_KM', 'is_part_of_knowledge_map');
define( 'DRAWING_ID_CACHE_NAME', 'knowledgemap_drawing_id_cache');

define( 'NEW_KM_ITEM_INDICATOR', '(New modal)');

module_load_include('inc', 'knowledgemap', 'knowledgemap.utils');

function knowledgemap_init() {
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();
// return;
    drupal_add_js('misc/ajax.js');

}

/**
 * Implements hook_menu.
 */
function knowledgemap_menu() {
  $items['show-km-item/%'] = array(
    'page callback' => 'knowledgemap_show_item',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  //Add a new item. Passing in the coords of the mouse click, and the 
  //nid of the KM that will own the new item.
  $items['add-km-item-ajax'] = array(
    'page callback' => 'knowledgemap_add_item_ajax',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['edit-km-item/%node/%ctools_js'] = array(
    'title' => 'Edit',
    'page callback' => 'knowledgemap_edit_item_ctools',
    'page arguments' => array(1, 2),
    'access callback' => 'node_access',
    'access arguments' => array('update', 1),
    'weight' => 0,
    'type' => MENU_CALLBACK,
  );
  $items['update-km-item-pos/%ctools_js'] = array(
    'page callback' => 'knowledgemap_save_item_position',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['confirm-delete-km-item/%'] = array(
    'page callback' => 'knowledgemap_confirm_delete',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['delete-km-item-confirmed/%'] = array(
    'page callback' => 'knowledgemap_delete_confirmed',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}


/**
 * Implements hook_field_info(). 
 * Creates one formatter and one input widget.
 */
function knowledgemap_field_info() {
  return array(
    'knowledgemap' => array(
      'label' => t('Knowledge map'),
      'description' => 
        t('This field stores a display of a knowledge map.'),
      'default_formatter' => 'knowledgemap_formatter',
      'default_widget' => 'knowledgemap_widget',
      'instance_settings' => array(
        'default_value' => ' ',
      ),
    ),
  );
}

/**
 * Implements hook_field_is_empty().
 */
function knowledgemap_field_is_empty($item, $field) {
  if (!isset($item['knowledgemap']) || $item['knowledgemap'] === '') {
    return TRUE;
  }
  return FALSE;
}

/**
 * Implements hook_field_widget_info.
 * 
 * Describes a widget for the KM field.
 * 
 */
function knowledgemap_field_widget_info() {
    return array(
      'knowledgemap_widget' => array(
      'label' => t('Knowledge map'),
      'description' => t(
          'Allow the user to edit KMs.'),
      'field types' => array('knowledgemap'),
    ),
  );
}

/**
 * Define the widget for the KM. 
 */
function knowledgemap_field_widget_form(&$form, &$form_state, 
    $field, $instance, $langcode, $items, $delta, $element) {
  //$element contains some of the Right Stuff already. Add to it.
  $base = $element;
  //Can't add KM items on new node.
  //Is this a new node? $node is the KM node that has the widget in it.
  $new_node = TRUE;
  if ( isset( $form_state['node'] ) ) {
    if ( isset( $form_state['node']->nid ) && ! isset($node->is_new)) {
      $new_node = FALSE;
    }
  }
  if ( $new_node ) {
    $element[$delta] = array(
      '#type' => 'markup',
      '#markup' => '<p>' . t('(Add KM items after knowledge map has been created.)') . '</p>',
    ) + $base;
    return $element;
  }
  //This is a node edit.
  $node = $form_state['node'];
//  drupal_add_js('misc/ajax.js');
  //What is the DOM id of the drawing area?
  $nid = $node->nid;
  $drawing_dom_id 
      = knowledgemap_compute_drawing_id( $nid );
  //Cache for later.
  knowledgemap_store_in_cache( DRAWING_ID_CACHE_NAME, $drawing_dom_id );
  $output = '';
  //Make container.
  $output .= 
         knowledgemap_edit_template($drawing_dom_id);
  //Make <div> for the drawing and item areas.
  $element[$delta] = array(
    '#type' => 'markup',
    '#markup' => $output,
  ) + $base;
  //Send the map data to the JS.
  $knowledgemap_rep = knowledgemap_make_km_rep($node->nid);
  $settings = array(
    'drawing_dom_id' => $drawing_dom_id,
    'km_nid' => $nid, //The nid of the KM being shown.
    'knowledgemap_rep' => $knowledgemap_rep,
  );
  drupal_add_js(
      array('knowledgemap' => $settings),
      'setting'
  );
  //Add libraries.
  ctools_include('modal');
  ctools_modal_add_js();
  ctools_modal_add_js('ajax-responder');
  ctools_modal_add_js('modal');
//  drupal_add_js('http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js', 'external');
  drupal_add_library('system', 'ui.dialog');
  drupal_add_js(
      drupal_get_path('module', 'knowledgemap') 
          . '/libs/jsPlumb/jquery.jsPlumb-1.4.1-all-min.js', 
      'file'
  );
//  drupal_add_js(
//    drupal_get_path('module', 'dialog') 
//        . '/jquery.xLazyLoader.js', 
//    'file'
//  );
//  drupal_add_js(
//    drupal_get_path('module', 'dialog') 
//        . '/dialog.js', 
//    'file'
//  );
  drupal_add_js(
      drupal_get_path('module', 'knowledgemap') 
          . '/libs/jquery-dialogextend/build/jquery.dialogextend.min.js', 
      'file'
  );
  //Add the KM drawing code.
  drupal_add_js(
      drupal_get_path('module', 'knowledgemap') 
          . '/js/knowledgemap_utils.js', 
      'file'
  );  
  drupal_add_js(
      drupal_get_path('module', 'knowledgemap') 
          . '/js/knowledgemap_item_viewer.js', 
      'file'
  );
  drupal_add_css(
      drupal_get_path('module', 'knowledgemap') 
          . '/css/knowledgemap_item_viewer.css', 
      'file'
  );
  drupal_add_js(
      drupal_get_path('module', 'knowledgemap') 
          . '/js/knowledgemap_common.js', 
      'file'
  );
  drupal_add_js(
      drupal_get_path('module', 'knowledgemap') 
          . '/js/knowledgemap_edit.js', 
      'file'
  );
  drupal_add_css(
      drupal_get_path('module', 'knowledgemap') 
          . '/css/knowledgemap_edit.css', 
      'file'
  );
  return $element;
}


function knowledgemap_make_km_rep($km_nid) {
  //Run the view showing KM items linked to the given KM.
  $view_results = views_get_view_result( 'items_related_to_km', 'default', $km_nid );
  //Store in array for JSONing later.
  $km_items = array();
  foreach( $view_results as $record ) {
    $nid = $record->nid;
    $title = $record->node_title;
    $body = isset( $record->field_body[0]['raw']['value'] ) 
        ? $record->field_body[0]['raw']['value'] : '';
    $coord_x = isset( $record->field_field_coord_x[0]['raw']['value'] ) 
        ? $record->field_field_coord_x[0]['raw']['value'] : '';
    $coord_y = isset( $record->field_field_coord_y[0]['raw']['value'] ) 
        ? $record->field_field_coord_y[0]['raw']['value'] : '';
    $item_type = isset( $record->field_field_item_type[0]['raw']['value'] ) 
        ? $record->field_field_item_type[0]['raw']['value'] : '';
    $km_items[$nid] = array(
      'nid' => $nid,
      'title' => $title,
      'body' => $body,
      'coord_x' => $coord_x,
      'coord_y' => $coord_y,
      'item_type' => $item_type,
    );
  }
  //Get KM item connection data.
  $view_results = views_get_view_result(
      'km_items_linked_to_other_km_items', 
      'default', 
      $km_nid
  );
  $connections = array();
  foreach ( $view_results as $record ) {
    $entity = $record->_field_data['relation_node_rid']['entity'];
    $rid = $entity->rid;
    $from_nid = $entity->endpoints[LANGUAGE_NONE][0]['entity_id'];
    $to_nid = $entity->endpoints[LANGUAGE_NONE][1]['entity_id'];
    $required = $entity->field_required[LANGUAGE_NONE][0]['value'];
    $connections[] = array(
      'rid' => $rid,
      'from_nid' => $from_nid,
      'to_nid' => $to_nid,
      'required' => $required,
    );
  }
  return array(
    'km_items' => $km_items,
    'connections' => $connections,
  );
}

//function knowledgemap_node_view($node, $view_mode, $langcode) {
//  $r=5;
//}


function knowledgemap_add_item_ajax() {
  $title = $_POST['title'];
  $item_type = $_POST['item_type'];
  $coord_x = $_POST['coord_x'];
  $coord_y = $_POST['coord_y'];
  $km_nid = $_POST['km_nid'];
  //Make a blank node.
  global $user;
  $new_node = (object) array(
    'title' => $title, 
    'uid' => $user->uid, 
    'name' => (isset($user->name) ? $user->name : ''), 
    'type' => 'knowledge_map_item', 
    'language' => LANGUAGE_NONE,
  );
  //Store the mouse coords in the new item.
  $new_node->field_coord_x[LANGUAGE_NONE][0]['value'] = $coord_x;
  $new_node->field_coord_y[LANGUAGE_NONE][0]['value'] = $coord_y;
  $new_node->field_item_type[LANGUAGE_NONE][0]['value'] = $item_type;
  node_save($new_node);
  $new_node_id = $new_node->nid;
  //Check for fail here.
  //Add a new relation.
  $endpoints = array(
    array('entity_type' => 'node', 'entity_id' => $new_node_id),
    array('entity_type' => 'node', 'entity_id' => $km_nid),
  );
  //Create new relation object.
  $new_relation = relation_create(RELATION_NAME_ITEM_TO_KM, $endpoints);
  //Save it.
  $rid = relation_save($new_relation);
  drupal_json_output( array( 
        'status' => 'success',
        'new_nid' => $new_node_id,
        'message' => 'Item created'
  ));
  drupal_exit();
}

/**
 * Implements hook_form_alter().
 * 
 * It adds a link to the KM edit form. That link can open a KM item edit
 * form in a modal. The link is copied onto each item viewer dialog.
 * It's done this way so that ctools will add the right event listener
 * to the link. The link has to be on the form.
 */
function knowledgemap_form_alter(&$form, &$form_state, $form_id) {
  if ( $form_id == 'knowledge_map_node_node_form' ) {
    global $base_url;
    $km_item_edit_link = ctools_modal_text_button(
        t('Edit'),
        $base_url . '/edit-km-item/km-item-nid/nojs',
        t('Edit'),
        'km-item-edit-link-original'
    );
    $form['km_item_edit_link'] = array(
      '#weight' => 500,
      '#type' => 'markup',
      '#markup' => $km_item_edit_link,
    );
    
  }
}


//function knowledgemap_form_alter(&$form, &$form_state, $form_id) {
//  if ( $form_id == 'knowledge_map_item_node_form' ) {
//    //The form could be in a modal, in which case the KM node the item
//    //should be associated with is known.
//    if ( $form['title']['#default_value'] == NEW_KM_ITEM_INDICATOR) {
//      //The form is in a modal.
//      $form['title']['#default_value'] = '';
//      //Remove the widget for the relation that 
//      //links the item to the knowledge map node. 
//      unset( $form['field_knowledge_map'] );
//      //Store whether his is an add or edit. Only the add needs
//      //special treatment later, to create the relationship after the 
//      //new nid is known.
//      $node = $form_state['node'];
//      $is_new_node = (!isset($node->nid) || isset($node->is_new));
//      $node->knowledgemap_operation 
//          = $is_new_node ? 'add' : 'edit';
//      //Hide the coord fields.
//      $form['field_coord_x']['#access'] = FALSE;
//      $form['field_coord_y']['#access'] = FALSE;
//      //Submit handler.
//      $form['#submit'][] = 'knowledgemap_submit_item_form';
//      //After build handler.
//      //$form['#after_build'][] = 'knowledgemap_submit_item_form';
//    }
//  }
//  
//}
//
//function knowledgemap_submit_item_form($form, &$form_state) {
//  global $base_url;
////  $form_state['redirect'][] = $base_url . '/add-done/nojs';
////  unset($_REQUEST['destination'], $_REQUEST['edit']['destination']);
//  $form_state['redirect'][] = drupal_get_destination();
//  $form_state['redirect'][] = $base_url . '/add-done/nojs';
//
//  unset($_GET['destination']);
//  drupal_static_reset('drupal_get_destination');
//  drupal_get_destination();
//  
//}


//function knowledgemap_edit_item( $ajax, $km_item_nid ) {
//  if ($ajax) {
//    drupal_add_js('misc/ajax.js');
//    drupal_add_library('system', 'drupal.ajax');
//    dialog_display(TRUE);
//    $title = 'Edit Item';
//    module_load_include('inc', 'node', 'node.pages');
//    $node = node_load($km_item_nid);
//    $content = drupal_get_form('page_node_form', $node);
//        $options = array(
//      'height' => rand(25, 75) . '%',
//      'width' => rand(25, 75) . '%',
//      'position' => 'center',
//      'title' => t('Dialog example'),
//    );
//
//    $commands = array();
//    $commands[] = dialog_command_display($content, $options);
//    ajax_deliver(array('#type' => 'ajax', '#commands' => $commands));
//  }
//}



/**
 * Page Callback - Modal: Edit Node.
 */
function knowledgemap_edit_item_ctools($node, $js = NULL) {
  // Check $js.
  if (!$js) {
//  if ( FALSE ) {
    return drupal_access_denied();
  }
  drupal_add_js('misc/ajax.js');
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js('ajax-responder');
  ctools_modal_add_js('modal');
  
  $type_name = node_type_get_name($node);
  $title = t('<em>Edit @type</em> @title', 
      array('@type' => $type_name, '@title' => $node->title)
  );

  $commands = array();

  ctools_include('node.pages', 'node', '');
  ctools_include('modal');
  ctools_include('ajax');

  $form_state = array(
    'title' => $title,
    'ajax'  => TRUE,
    'build_info' => array(
      'args'  => array($node),
    ),
  );

  $commands = ctools_modal_form_wrapper($node->type . '_node_form', $form_state);

  if (!empty($form_state['executed']) && empty($form_state['rebuild'])) {
      $node = $form_state['node'];
      // overwrite commands.
      $commands = array();

      ctools_add_js('ajax-responder');
      $commands[] = ctools_modal_command_dismiss();
      //Send new item data to the client.
      $new_item_data = array(
        'knowledgemap' => array(
          'new_item_data' => array(
            'item_type' => $node->field_item_type[LANGUAGE_NONE][0]['value'],
            'title' => $node->title,
            'body' => $node->body[LANGUAGE_NONE][0]['value'],
          ),
        ),
      );
      $commands[] = ajax_command_settings($new_item_data, TRUE);
      $commands[] = ajax_command_invoke(
          'body', 
          'returnFromEditSave', 
          array( $node->nid )
      );
//      if ($force_page_reload) {
//        $commands[] = ctools_ajax_command_reload();
//      }
  }

  // add CSS class to Modal-Frame
//  $commands[] = ajax_command_invoke('#modalContent', 'addClass', array('custom-module-node', 'custom-module-node-form'));

  print ajax_render($commands);
  exit;
}